---
title: "EDS232_lab1"
author: "Joe DeCesaro"
date: "1/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load packages, installing if missing
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}
librarian::shelf(
  dismo, dplyr, DT, ggplot2, here, htmltools, leaflet, mapview, purrr, raster, readr, rgbif, rgdal, rJava, sdmpredictors, sf, spocc, tidyr, geojsonio)
select <- dplyr::select # overwrite raster::select

# set random seed for reproducibility
set.seed(42)

# directory to store data
dir_data <- here("data/sdm")
dir.create(dir_data, showWarnings = F)
```

## Get Species Observations
```{r}
obs_csv <- file.path(dir_data, "obs.csv")
obs_geo <- file.path(dir_data, "obs.geojson")

# get species occurrence data from GBIF with coordinates
(res <- spocc::occ(
  query = 'Enhydra lutris', 
  from = 'gbif', has_coords = T,
  limit = 10000))
```

### Extract data from the result
```{r}
df <- res$gbif$data[[1]] 
nrow(df)
```


### convert to points of observation from lon/lat columns in data frame
```{r}
obs <- df %>% 
  sf::st_as_sf(
    coords = c("longitude", "latitude"),
    crs = st_crs(4326))

readr::write_csv(df, obs_csv) 
#sf::write_sf(obs, obs_geo)
geojsonio::geojson_write(obs, obs_geo)
# show points on map
mapview::mapview(obs, map.types = "Esri.OceanBasemap")
```

## Question 1: How many observations total are in GBIF for your species?
13,716

## Question 2: Do you see any odd observations, like marine species on land or vice versa?
It looks like there are a few otters in the North Atlantic Ocean which does not make sense for this species. Also, there is one sighting in the Arctic, north of Alaska and one in the middle of Alaska. All of these will be accounted for below.

```{r}
obs_clean <- obs[-c(1524, 2102, 2526, 6800, 6801, 6802, 6803, 6850, 7337), ] 

obs_clean <- obs_clean %>% 
  filter(identifier != "urn:catalog:CAS:MAM:28877",
         identifier != "urn:catalog:CAS:MAM:31813")

mapview::mapview(obs_clean, map.types = "Esri.OceanBasemap")

```

## Get Environmental Data
```{r}
dir_env <- file.path(dir_data, "env")

# set a default data directory
options(sdmpredictors_datadir = dir_env)

# choosing terrestrial
env_datasets <- sdmpredictors::list_datasets(terrestrial = TRUE, marine = FALSE)

# show table of datasets
env_datasets %>% 
  select(dataset_code, description, citation) %>% 
  DT::datatable()
```

```{r}
# choose datasets for a vector
env_datasets_vec <- c("WorldClim", "ENVIREM")

# get layers
env_layers <- sdmpredictors::list_layers(env_datasets_vec)
DT::datatable(env_layers)
```


```{r}
# choose layers after some inspection and perhaps consulting literature
env_layers_vec <- c("WC_alt", "WC_bio1", "WC_bio2", "ER_tri", "ER_topoWet")

# get layers
env_stack <- load_layers(env_layers_vec)

# interactive plot layers, hiding all but first (select others)
mapview(env_stack, hide = T)
```

```{r}
obs_hull_geo <- file.path(dir_data, "obs_hull.geojson")

# make convex hull around points of observation
obs_hull <- sf::st_convex_hull(st_union(obs_clean))

# show points on map
mapview(
  list(obs_clean, obs_hull))
```

```{r}
# save obs hull
write_sf(obs_hull, obs_hull_geo)

obs_hull_sp <- sf::as_Spatial(obs_hull)

env_stack <- raster::mask(env_stack, obs_hull_sp) %>% 
  raster::crop(extent(obs_hull_sp))

mapview(obs) + 
  mapview(env_stack, hide = T)
```


### 2.4.2 Pseudo-Absence
```{r}
absence_geo <- file.path(dir_data, "absence.geojson")
pts_geo     <- file.path(dir_data, "pts.geojson")
pts_env_csv <- file.path(dir_data, "pts_env.csv")

# get raster count of observations
r_obs <- rasterize(
  sf::as_Spatial(obs_clean), env_stack[[1]], field=1, fun='count')

mapview(obs_clean) + 
  mapview(r_obs)
```

